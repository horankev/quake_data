---
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, 
  message = FALSE, 
  warning = FALSE,
  echo = FALSE,
  comment = "#>"
)
```

# Indonesia earthquakes datasets

These datasets contain spatio-temporal information about earthquakes in Indonesia. All five datasets are `sf` dataframes which can be mapped. **quakes_df** contains records for individual earthquakes. **provinces_df** contains records for each province, including aggregations of eathquake counts and densities. **counties_df** contains the same for lower-level administrative boundaries. **faults_df** contains linestrings of the faultlines in the area. Finally, **nearby_countries_df** is a small spatial dataset containing polygons for the five nearby or bordering countries which are not part of Indonesia. These can be used when mapping to give more context to the map.

## Summary

The organisation of the datasets can be summarised as follows:

| dataset                 | summary                                                                                                                                                                                                   |
|-----------------------|-------------------------------------------------|
| **quakes_df**           | simple features dataframe containing 67,268 records for all earthquakes \>= 2.5 magnitude from 1 January 1985 to 31 December 2023, with epicentre within bounding box *xmin=92,xmax=143,ymin=-12,ymax=10* |
| **provinces_df**        | simple features dataframe for 33 provinces of Indonesia with details of quakes whose epicentres lay within each zone                                                                                      |
| **counties_df**         | simple features dataframe for 387 kabupaten/kota, here referred to as counties, of Indonesia with details of quakes whose epicentres lay within each zone                                                 |
| **faults_df**           | simple features dataframe for faultlines which lie within bounding box *xmin=92,xmax=143,ymin=-12,ymax=10*                                                                        |
| **nearby_countries_df** | simple features dataframe of 5 other countries which lie within the same bounding box                                                                                                                       |

## Descripton of datasets

### quakes_df

| attribute        | type      | description                                                                                                                              |
|-----------|-----------|--------------------------------------------------|
| id               | character | individual id for each earthquake                                                                                                        |
| ymd              | POSIXct   | year, month, day                                                                                                                         |
| hms              | time      | hour, minute, second                                                                                                                     |
| mag              | numeric   | magnitude of earthquake                                                                                                                  |
| magfact          | factor    | magnitude classified as S, M, L or XL                                                                                                    |
| county           | factor    | name of level-two administrative division where epicentre is located. *undersea* if epicentre is not within Indonesian landmass          |
| county_id        | numeric   | individual id of level-two administrative division where epicentre is located. *undersea* if epicentre is not within Indonesian landmass |
| province         | factor    | name of level-one administrative division where epicentre is located. *undersea* if epicentre is not within Indonesian landmass          |
| province_id      | numeric   | individual id of level-one administrative division where epicentre is located. *undersea* if epicentre is not within Indonesian landmass |
| place            | character | general description of location, where available                                                                                         |
| time             | character | character representation of time                                                                                                         |
| depth            | numeric   | depth of earthquake in kilometres                                                                                                        |
| closest_fault_id | character | id of closest faultline from faults_df dataframe                                                                                         |
| slip_type        | factor    | faulting type of closest faultline from faults_df dataframe                                                                              |
| geometry         | sfc_POINT | points of earthquake epicentres                                                                                                          |

Sourced from the [USGS earthquake catalogue API](https://earthquake.usgs.gov/earthquakes/search/). More detailed attribute descriptions available [here](https://earthquake.usgs.gov/data/comcat/index.php#1).

### provinces_df

| attribute           | type         | description                                                                                                         |
|------------------|------------------|------------------------------------|
| province            | factor       | names of 33 provinces: level-one administrative divisions (Indonesian: *provinsi*)                                  |
| province_id         | numeric      | unique identifier for each province                                                                                 |
| S                   | numeric      | total "small" earthquake count with epicentre within province where magnitude is in the range 2.5 - 5.4             |
| M                   | numeric      | total "medium" earthquake count with epicentre within province where magnitude is in the range 5.5 - 6.0            |
| L                   | numeric      | total "major" earthquake count with epicentre within province where magnitude is in the range 6.1 - 6.9               |
| XL                  | numeric      | total "great" earthquake count with epicentre within province where magnitude is 7 or greater                       |
| quake_total         | numeric      | sum of earthquake count with epicentre within province                                                              |
| quake_density       | numeric      | density of quakes with epicentre within province (total per kilometre squared)                                      |
| quake_mlxl_total    | numeric      | sum of earthquake count with epicentre within province and magnitude 5.5 or greater                                 |
| quake_mlxl_density  | numeric      | density of quakes with epicentre within province and magnitude 5.5 or greater (total per kilometre squared)         |
| area_fault_within   | numeric      | area of faultline within province in kilometres squared (where faultline becomes two-dimensional via a 10km buffer) |
| area_province       | numeric      | area of province in kilometres squared                                                                              |
| fault_concentration | numeric      | area of faultlines within province per square kilometre                                                             |
| geometry            | sfc_GEOMETRY | polygons of provinces                                                                                               |

### counties_df

| attribute           | type         | description                                                                                                                              |
|------------------|------------------|------------------------------------|
| county              | factor       | names of 387 regencies/cities (Indonesian: *kabupaten/kota*): level-two administrative divisions, referred to as counties for simplicity |
| county_id           | numeric      | unique identifier for each county                                                                                                        |
| province            | factor       | names of 33 provinces: level-one administrative divisions (Indonesian: *provinsi*)                                                       |
| province_id         | numeric      | unique identifier for each province                                                                                                      |
| county_type         | factor       | regency or city (Indonesian: *kabupaten/kota*)                                                                                           |
| S                   | numeric      | total "small" earthquake count with epicentre within county where magnitude is in the range 2.5 - 5.4                                    |
| M                   | numeric      | total "medium" earthquake count with epicentre within county where magnitude is in the range 5.4 - 6.1                                   |
| L                   | numeric      | total "major" earthquake count with epicentre within county where magnitude is in the range 6.1 - 7                                      |
| XL                  | numeric      | total "great" earthquake count with epicentre within county where magnitude is 7 or greater                                              |
| quake_total         | numeric      | sum of earthquake count with epicentre within county                                                                                     |
| quake_density       | numeric      | density of quakes with epicentre within county (total per kilometre squared)                                                             |
| quake_mlxl_total    | numeric      | sum of earthquake count with epicentre within county and magnitude 5.4 or greater                                                        |
| quake_mlxl_density  | numeric      | density of quakes with epicentre within county and magnitude 5.4 or greater (total per kilometre squared)                                |
| area_fault_within   | numeric      | area of faultline within county in kilometres squared (where faultline becomes two-dimensional via a 10km buffer)                        |
| area_county         | numeric      | area of county in kilometres squared                                                                                                     |
| fault_concentration | numeric      | area of faultlines within county per square kilometre                                                                                    |
| geometry            | sfc_GEOMETRY | polygons of counties                                                                                                                     |

### faults_df

| attribute  | type      | description               |
|------------|-----------|---------------------------|
| catalog_id | character | gloabal fault ID          |
| catalog_na | character | global fault name         |
| name       | character | name of fault zone        |
| slip_type  | factor    | type of faulting          |
| geometry   | sfg list  | linestrings of faultlines |

Taken from the [GEM Foundation's](https://www.globalquakemodel.org/) Global Active Faults Database (GEM GAF-DB), as extracted by [Richard Styron](https://github.com/cossatot).

Styron, Richard, and Marco Pagani. “The GEM Global Active Faults Database.” *Earthquake Spectra*, vol. 36, no. 1_suppl, Oct. 2020, pp. 160–180, <doi:10.1177/8755293020944182>.

<https://journals.sagepub.com/doi/abs/10.1177/8755293020944182>

### nearby_countries_df

For the purposes of context when mapping, the polygons outlines of neighbouring countries within the bounding-box are provided:

| attribute | type     | description            |
|-----------|----------|------------------------|
| name      | factor   | name of nearby country |
| geometry  | sfg list | polygons of countries  |

## Preparation of datasets

The code for the assembly of these datasets is available in the file **codeprep.Rmd**.

```{r, echo=FALSE}

## Data and packages

# Read in data and necessary packages.

# install.packages("devtools")
# devtools::install_github("horankev/sfislands")

# required packages
packages <- c(
  "tidyverse",
  "sf",
  "ggpubr",
  "here",
  "rnaturalearth",
  "ggspatial",
  "rmapshaper"
)

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Packages loading
invisible(lapply(packages, library, character.only = TRUE, quietly = TRUE))

theme_set(theme_bw() +
    theme(panel.background = element_rect(fill = "#ECF6F7", color = "black"),
          axis.text = element_blank()))

```

```{r}

quakes_df <- readRDS("datasets/quakes_df.rds")
provinces_df <- readRDS("datasets/provinces_df.rds")
counties_df <- readRDS("datasets/counties_df.rds")
faults_df <- readRDS("datasets/faults_df.rds")
nearby_countries_df <- readRDS("datasets/nearby_countries_df.rds")

```

## Visualisations from datasets

### faults_df

```{r}

indonesia_outline <- provinces_df |> summarise()

```

Below is a map of Indonesia, with other neighbouring or bordering countries filled in grey. The many local faultlines which lie within 300km of the shore are shown as green lines.

```{r, fig.width=12, fig.height=5}

ggplot() + 
  geom_sf(data=nearby_countries_df, fill="gray90", linewidth=0.5, colour="black") +
  geom_sf(data=provinces_df, fill="antiquewhite", linewidth=0.5, colour="black") +
  geom_sf(data=faults_df, colour="darkgreen", linewidth=0.3) +
  guides(fill="none") + 
  annotation_scale() + 
  labs(title = "faultlines") + 
  theme_bw() + 
  theme(panel.background = element_rect(fill = "#ECF6F7", color = "black"),
        panel.grid.major = element_line(colour = "white", linewidth=2))

```

The category of fault is an attribute of **faults_df**:

```{r, fig.width=12, fig.height=5}

faults_with_types <- faults_df |> 
  filter(!is.na(slip_type))
ggplot() + 
  geom_sf(data=nearby_countries_df, fill="gray20", linewidth=0.5, colour="black") +
  geom_sf(data=provinces_df, fill="antiquewhite", linewidth=0.5, colour="black") +
  geom_sf(data=faults_with_types, aes(colour=slip_type), linewidth=2) +
  scale_colour_brewer(palette = "Paired", direction = -1) + 
  guides(fill="none") + 
  annotation_scale() +
  labs(title = "faultlines by type") + 
  coord_sf(datum=NA) + 
  theme(axis.title = element_blank(),
        axis.ticks = element_blank())

```

#### faultline concentration

To get an interpretable measure of faultline concentration in any area for use in **provinces_df** and **counties_df**, they are transformed from linestrings to polygons by setting a buffer  of 10km around them, as shown below. This is now in units of kilometres squared and be compared with the area of administrative units to give concentrations.

We can subsequently measure what proportion of any administrative unit is covered by these buffered faultlines.

```{r, fig.width=12, fig.height=5}

faults_buf <- faults_df |> 
  st_buffer(dist = 10000)

ggplot() + 
  geom_sf(data=nearby_countries_df, fill="gray50", linewidth=0.6, colour="black") +
  geom_sf(data = provinces_df, fill="antiquewhite", colour="black",linewidth=0.6) +
  geom_sf(data = faults_buf, fill="darkgreen", colour="gray50",linewidth=0.9) +
  geom_sf(data=faults_df, colour="yellow", linewidth=0.4) +
  annotation_scale() +
  coord_sf(datum=NA) + 
  labs(title = "buffered faultlines") + 
  theme(axis.title = element_blank(),
        axis.ticks = element_blank())

```

### provinces_df

This dataset contains a number of attributes for each province including counts and concentrations of earthquakes whose epicentres occurred within that province, and measures of faultline concentration as mapped below:

```{r, fig.width=12, fig.height=5}

ggplot() + 
  geom_sf(data=nearby_countries_df, fill="gray90", colour="black", linewidth=0.5) +
  geom_sf(data=provinces_df, aes(fill=fault_concentration), colour="black", linewidth=0.5) +
  geom_sf(data=faults_df, colour="darkgreen", linetype="dashed", linewidth=0.7) +
  scale_fill_distiller(palette = "YlOrRd", direction = 1) + 
  labs(fill="faultline\nconcentration") + 
  annotation_scale() +
  coord_sf(datum=NA)

```

### counties_df

The same can be done by county:

```{r, fig.width=12, fig.height=5}

ggplot() + 
  geom_sf(data=counties_df[counties_df$fault_concentration < 4,], 
          aes(fill=fault_concentration, colour=fault_concentration), linewidth=0.5) +
  geom_sf(data=counties_df[counties_df$fault_concentration >= 4,], 
          fill="red", colour="red", linewidth=0.5) +
  geom_sf(data=faults_df, colour="darkgreen", linetype="dashed", linewidth=0.3) +
  geom_sf(data=indonesia_outline, fill=NA, colour="black", linewidth=0.5) +
  geom_sf(data=nearby_countries_df, fill="gray90", colour="black", linewidth=0.5) +
  scale_fill_distiller(palette = "YlOrRd", direction = 1) + 
  scale_colour_distiller(palette = "YlOrRd", direction = 1) + 
  labs(fill="faultline\nconcentration",
       colour="faultline\nconcentration") + 
  annotation_scale() +
  coord_sf(datum=NA)

```

### quakes_df

The following map shows a random sample of 20,000 (for visualisation purposes) of the 67,268 earthquakes in **quakes_df** of magnitude \>= 2.5 recorded in the region of Indonesia from 1 January 1985 to 31 December 2023. The faultlines from **faults_df** are also shown:

```{r, fig.width=12, fig.height=5}

set.seed(12345)
quakes_sample <- quakes_df[sample(1:nrow(quakes_df),20000),]

ggplot() + 
  geom_sf(data=nearby_countries_df, fill="gray90", linewidth=0.5, colour="black") +
  geom_sf(data=provinces_df, fill="antiquewhite", linewidth=0.5,colour="black") + 
  geom_sf(data=quakes_sample, size=0.05, shape=3, colour="red3") +
  geom_sf(data=faults_df, colour="darkgreen", linetype="dashed", linewidth=1) +
  labs(title = "sample of 20,000 earthquakes") + 
  annotation_scale() +
  coord_sf(datum=NA)

```

#### location

The attributes *province* and *county* give the name of each province/county where the earthquake was centred, or registers it as *undersea* if it was not within any landmass.

```{r, fig.width=12, fig.height=10}

ggarrange(
  
  ggplot() + 
  geom_sf(data=provinces_df, fill="antiquewhite", colour="black", linewidth=0.6) + 
  geom_sf(data=counties_df, fill=NA, colour="grey", linewidth=0.1) + 
  geom_sf(data=quakes_df |> filter(magfact != "S") |> filter(province != "undersea"), 
          colour="red", shape=3, size=5) +
  geom_sf(data=nearby_countries_df, fill="gray90", linewidth=0.6, colour="black") +
    labs(title = "all earthquakes: within province / county") + 
  annotation_scale() +
  coord_sf(datum=NA),
  
  ggplot() + 
  geom_sf(data=provinces_df, fill="antiquewhite", colour="black", linewidth=0.6) + 
  geom_sf(data=counties_df, fill=NA, colour="grey", linewidth=0.1) + 
  geom_sf(data=quakes_df |> filter(magfact != "S") |> filter(province == "undersea"), 
          colour="blue", shape=3, size=5) +
  geom_sf(data=nearby_countries_df, fill="gray90", linewidth=0.6, colour="black") +
    labs(title = "all earthquakes: undersea") + 
  annotation_scale() +
  coord_sf(datum=NA),
  
  nrow = 2
)

```

#### magnitude

The magnitude scale which measures the amount of energy released by an earthquake is shown below, and the descriptions of effects are taken from <https://www.mtu.edu/geo/community/seismology/learn/earthquake-measure/magnitude/>.

Earthquake magnitude scale:

| magnitude      | effects                                                              | category |
|-------------------|----------------------------------|-------------------|
| 2.5 or less    | usually not felt, but can be recorded by seismograph                 | XS       |
| 2.5 to 5.4     | often felt, but only causes minor damage                             | S        |
| 5.5 to 6.0     | slight damage to buildings and other structures                      | M        |
| 6.1 to 6.9     | may cause a lot of damage in very populated areas                    | L        |
| 7.0 to 7.9     | major earthquake. serious damage                                     | XL       |
| 8.0 or greater | great earthquake. can totally destroy communities near the epicentre | XL       |

**quakes_df** contains records for earthquakes of size **S** and greater, according to the above table.

Those whose centres occurred under Indonesia's landmass can be visualised by size:

```{r, fig.width=12, fig.height=5}


ggplot() + 
  geom_sf(data=provinces_df, fill="antiquewhite", colour="black", linewidth=0.6) + 
  geom_sf(data=counties_df, fill=NA, colour="grey", linewidth=0.1) + 
  geom_sf(data=quakes_df |> filter(province != "undersea"), 
          aes(fill=magfact, colour=magfact, size=magfact), shape=21) +
  geom_sf(data=nearby_countries_df, fill="gray90", linewidth=0.6, colour="black") +
  scale_fill_manual(values = c("gray90","yellow","orange","red")) +
  scale_size_manual(values = c(1,3,5,7)) +
  labs(fill="category",
       size="category",
       colour="category") + 
  annotation_scale() +
  coord_sf(datum=NA)

```

Or, excluding the **S** category:

```{r, fig.width=12, fig.height=5}

ggplot() + 
  geom_sf(data=nearby_countries_df, fill="gray90", linewidth=0.6, colour="black") +
  geom_sf(data=provinces_df, fill="antiquewhite", colour="black", linewidth=0.6) + 
  geom_sf(data=quakes_df |> filter(magfact != "S") |> filter(province != "undersea"), 
          aes(fill=magfact, size=magfact), shape=21, colour="black") +
  scale_fill_manual(values = c("white","orange","red")) +
  scale_size_manual(values = c(3,5,7)) + 
  labs(fill="category",
       size="category") + 
  annotation_scale() +
  coord_sf(datum=NA)

```

#### count and incidence by province:

**provinces_df** and **counties_df** contain records of count and incidence (or density per square kilometre) 

```{r, fig.width=12, fig.height=10}

ggarrange(
  
  ggplot() +
  geom_sf(data=nearby_countries_df, fill="gray90", colour="black", linewidth=0.5) +
  geom_sf(data=provinces_df, aes(fill=quake_mlxl_total), colour="black", linewidth=0.5) +
  scale_fill_distiller(palette = "YlOrRd", direction = 1) + 
  labs(fill="quake_mlxl_total",
       title = "count of earthquakes (mag > 5.5)",
       subtitle = "by province") + 
  annotation_scale() +
  coord_sf(datum=NA),
  
  ggplot() +
  geom_sf(data=nearby_countries_df, fill="gray90", colour="black", linewidth=0.5) +
  geom_sf(data=provinces_df, aes(fill=quake_mlxl_density), colour="black", linewidth=0.5) +
  scale_fill_distiller(palette = "YlOrRd", direction = 1) + 
  labs(fill="quake_mlxl_density",
       title = "density of earthquakes (mag > 5.5)",
       subtitle = "by province") + 
  annotation_scale() +
  coord_sf(datum=NA) + 
  theme(axis.title = element_blank(),
        axis.ticks = element_blank()),
  
  nrow = 2
)

```

#### count and incidence by county:

```{r, fig.width=12, fig.height=10}

ggarrange(
  
  ggplot() +
  geom_sf(data=nearby_countries_df, fill="gray90", colour="black", linewidth=0.4) +
  geom_sf(data=counties_df, aes(fill=quake_mlxl_total, colour=quake_mlxl_total)) +
  geom_sf(data=indonesia_outline, fill=NA, colour="black", linewidth=0.6) +
  scale_fill_distiller(palette = "YlOrRd", direction = 1) + 
  scale_colour_distiller(palette = "YlOrRd", direction = 1) + 
  labs(fill="quake_mlxl_total",
       title = "count of earthquakes (mag > 5.5)",
       subtitle = "by county") + 
  annotation_scale() +
  coord_sf(datum=NA),
  
  ggplot() +
  geom_sf(data=nearby_countries_df, fill="gray90", colour="black", linewidth=0.4) +
  geom_sf(data=counties_df, aes(fill=quake_mlxl_density, colour=quake_mlxl_density)) +
  geom_sf(data=indonesia_outline, fill=NA, colour="black", linewidth=0.6) +
  scale_fill_distiller(palette = "YlOrRd", direction = 1) + 
  scale_colour_distiller(palette = "YlOrRd", direction = 1) + 
  labs(fill="quake_mlxl_density",
       title = "density of earthquakes (mag > 5.5)",
       subtitle = "by county") + 
  annotation_scale() +
  coord_sf(datum=NA) + 
  theme(axis.title = element_blank(),
        axis.ticks = element_blank()),
  
  nrow = 2
)

```

#### density maps

If we include all earthquakes, both undersea and beneath Indonesia's land mass, their counts can be represented as density plots. When faceted by magnitude, we get the following:

```{r, fig.width=12, fig.height=6}

ggplot() +
    stat_density_2d(data = quakes_df, 
                    mapping = aes(x = purrr::map_dbl(geometry, ~.[1]),
                                  y = purrr::map_dbl(geometry, ~.[2]),
                                  fill = stat(density)),
                    geom = 'tile',
                    contour = FALSE,
                    alpha = 0.8) +
    geom_sf(data = provinces_df, fill = NA) + 
    scale_fill_viridis_c(option = 'magma', direction = -1) +
    coord_sf(datum=NA) + 
  labs(title = "earthquake occurrence",
       subtitle = "by magnitude class") + 
    theme(axis.title = element_blank(),
          axis.ticks = element_blank()) + 
  facet_wrap(~magfact, ncol = 2)

```

Or by year:

```{r, fig.width=12, fig.height=10}

ggplot() +
    stat_density_2d(data = quakes_df, 
                    mapping = aes(x = purrr::map_dbl(geometry, ~.[1]),
                                  y = purrr::map_dbl(geometry, ~.[2]),
                                  fill = stat(density)),
                    geom = 'tile',
                    contour = FALSE,
                    alpha = 0.8) +
    geom_sf(data = provinces_df, fill = NA) + 
    scale_fill_viridis_c(option = 'magma', direction = -1) +
    coord_sf(datum=NA) + 
  labs(title = "earthquake occurrence",
       subtitle = "by year") + 
    theme(axis.title = element_blank(),
          axis.ticks = element_blank()) + 
  facet_wrap(~year(ymd), ncol = 5)

```




















